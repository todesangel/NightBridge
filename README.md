# NightBridge: руководство по запуску и обслуживанию

## Требования и важное предупреждение

Перед запуском убедитесь, что:

- ОС: **Windows 10/11** (x64).
- У вас есть права локального администратора.
- Установлены зависимости, включая **WinDivert** (драйвер/библиотека, используемая профилями фильтрации).
- `service.bat` и сопутствующие `.ps1`-скрипты находятся в одной рабочей директории проекта.

> ⚠️ **Важно:** большинство операций (установка/перезапуск службы, загрузка драйвера, изменение сетевых правил) требуют запуска с **админ-правами**. Если запускать без них, команды могут «успешно» завершаться, но фактически ничего не применится.

---

## Быстрый старт

Минимальный сценарий первичной проверки:

1. Откройте PowerShell **от имени администратора** в папке проекта.
2. Выполните предварительную проверку окружения:
   ```powershell
   powershell -ExecutionPolicy Bypass -File "test zapret.ps1"
   ```
3. Запустите профиль вручную (в текущей сборке `service.bat` принимает режим `on|off|any`):
   ```bat
   service.bat any
   ```
4. Для безопасной проверки только сборки списков (без запуска winws) используйте dry-run:
   ```bat
   set DRY_RUN=1
   service.bat any
   ```

Если `test zapret.ps1` показывает ошибки, сначала устраните их (WinDivert, права, отсутствующие файлы).

---

## Профили: что выбрать и когда

Ниже — практическая логика выбора профиля. Названия профилей могут отличаться в конкретной сборке, но обычно встречаются варианты **ALT / FAKE / SIMPLE**.

### SIMPLE

**Когда выбирать:**

- Начальный запуск и базовая совместимость.
- Стабильный канал без сложных ограничений.
- Нужен максимально предсказуемый режим с минимальным количеством «хаков».

**Плюсы:**

- Проще диагностировать.
- Обычно меньше побочных эффектов.

**Минусы:**

- Может не обходить более агрессивные блокировки.

### ALT

**Когда выбирать:**

- Если `SIMPLE` не дал результата.
- В сети провайдера/оператора наблюдаются нестабильные блокировки.
- Нужна альтернативная стратегия обработки трафика.

**Плюсы:**

- Часто помогает в «пограничных» случаях, где базовый профиль не работает.

**Минусы:**

- Может вести себя по-разному в разных сетях.
- Иногда требует дополнительного подбора параметров.

### FAKE

**Когда выбирать:**

- При жёстких фильтрах, где `SIMPLE` и `ALT` не сработали.
- Когда нужен «маскирующий»/эмулирующий подход к части трафика.

**Плюсы:**

- Самый «пробивной» вариант в сложных ограничениях.

**Минусы:**

- Наиболее чувствителен к конфликтам (VPN, антивирусные сетевые фильтры, фаерволы).
- Может повышать задержки или нестабильность на части ресурсов.

### Рекомендуемый порядок выбора

1. `SIMPLE` → 2. `ALT` → 3. `FAKE`.

Переходите к следующему профилю только после повторного запуска `service.bat` с нужным режимом и теста `test zapret.ps1`.

---

## Диагностика типовых ошибок

### 1) Не установлен WinDivert

**Симптомы:**

- Служба не стартует.
- В логах/консоли есть упоминания `WinDivert`, `driver not found`, `failed to open driver`.

**Что делать:**

1. Установите/переустановите WinDivert совместимой версии (x64).
2. Убедитесь, что файлы драйвера доступны процессу службы.
3. Перезапустите профиль с админ-правами и снова выполните проверку:
   ```bat
   service.bat any
   powershell -ExecutionPolicy Bypass -File "test zapret.ps1"
   ```

### 2) Профиль не применяется

**Симптомы:**

- После `service.bat any` нет ожидаемого поведения.
- Видны только диагностические сообщения без фактического применения правил.

**Что делать:**

1. Запускайте консоль **от имени администратора**.
2. Проверьте, что путь к скриптам не содержит «сломанных» кавычек/нестандартных символов.
3. Перезапустите `service.bat` и повторите `test zapret.ps1`.
4. Смените профиль (`SIMPLE` → `ALT` → `FAKE`) и протестируйте заново.


### 3) `winws.exe` не запускается

**Симптомы:**

- `service.bat` завершает работу с ошибкой `winws.exe not found`.
- Или `winws` запускается, но сразу завершается с кодом ошибки.

**Что делать:**

1. Положите `winws.exe` в ту же папку, где лежит `service.bat`, либо добавьте его в `PATH`.
2. Проверьте корректность параметров вашего билда `winws` (в разных версиях набор ключей может отличаться).
3. Сначала выполните dry-run (`DRY_RUN=1`) и убедитесь, что формируются `runtime\hostlist-active.txt` и `runtime\ipset-active.txt`.
4. Повторно запустите:
   ```powershell
   powershell -ExecutionPolicy Bypass -File "test zapret.ps1"
   ```

### 4) Конфликт с VPN/фаерволом

**Симптомы:**

- После включения профиля пропадает доступ в интернет.
- VPN перестаёт поднимать туннель или трафик «зависает».

**Что делать:**

1. Временно отключите сторонний VPN/фаервол и проверьте работу.
2. Если проблема исчезла — добавьте исключения для службы/скриптов NightBridge.
3. Используйте менее агрессивный профиль (`SIMPLE` или `ALT`) вместо `FAKE`.
4. Проверьте порядок запуска: сначала VPN, затем NightBridge (или наоборот) и выберите стабильный вариант.

---

## Откат и полное удаление

### Быстрый откат (временное отключение)

1. Закройте консоль/процесс, где запущен профиль NightBridge.
2. Если вы добавляли постоянные правила вручную, удалите их обратными командами вашего движка (winws/zapret/nfqws).
3. При необходимости перезагрузите ПК, чтобы гарантированно выгрузить драйвер/правила.

### Полное удаление

1. Остановите и удалите службу NightBridge (через `service.bat` или `sc delete`, если применимо в вашей сборке).
2. Удалите файлы проекта и связанные служебные скрипты.
3. Удалите/очистите компоненты WinDivert (если они ставились только для NightBridge).
4. Перезагрузите систему.
5. Убедитесь, что служба отсутствует и сетевой стек работает штатно.

> Рекомендуется перед удалением сохранить текущие конфиги и логи, чтобы упростить последующую повторную настройку.
